import Alert from "../components/TailwindUI/Alert";

# Concepts

<Alert title="Intended Level: Intermediate">
  This section explains some thought process and design concepts behind GQty. It
  assumes a certain degree of knowledge across multiple domains, such as the
  experience using other GraphQL clients, Web standards and cache management in
  JavaScript.
</Alert>

## A cache that fetches

The core concept behind GQty is simple, you interact with the cache while it
automatically fetches missing data on-the-fly.

### Scoped Queries

While it is handy for a centralized group of cache accessors that groups all
selections and fetches as much as possible in one go, there are use cases where
separation is necessary.

It is especially important when implementing persisted queries and operation
names. Selections under these context cannot be mixed up with other queries
under a different one.

Scoped contexts contain the following elements, which may affect how Selections
are combined and ultimately fetched.

1. Operation Name
1. Cache Policy
1. Suspense

Suspense is the most important consideration point if you have Suspense enabled.
It determines which level and how many levels in the component tree a query may
be suspended and fetched, it also decides the error boundaries of you app.

### Selection Batching

When making selections by interacting with the cache, GQty captures what is
being accessed, combine selections with the same context, and fetches them with
as few network requests as possible.

<Alert title="Pass query objects as props">
  In React, the `useQuery()` hook creates a new scoped context each time it is
  being called. Scoped contexts split up selections which may not be what you
  wanted. Instead, you should pass query objects down the component tree as if
  they are data already fetched. This allows selections to be grouped into one
  single request.
</Alert>

## All queries are live queries

In React, components create live subscriptions to the current cache even if only
queries are used. This allows most of the normalization magic happens when a
seemingly unrelated changes or fetch from other components arrives, all
components reaching such objects will also be updated.

## Cache Expiry

The cache in GQty has expiry built-in. Cache values are held with `WeakRef` with
a timer, when expire time comes, it is automatically open to Garbage Collection.

Why not a timed eviction instead? Because we want SWR!

### Stale While Revalidate (SWR)

For stale-while-revalidate to make sense, we should have "stale" caches that
stays as long as there is no pressure for evictions. Garbage Collection in
JavaScript engines are doing exactly the same thing, so we can leverage that
instead of pretending to be stale with strong references.

## Cache Policy

When designing an expiring cache with stale-while-revalidate (SWR) support,
there is an important concept inherited from the Web standards:
[`Request.cache`](https://developer.mozilla.org/en-US/docs/Web/API/Request/cache).

`Request.cache` is the strategy dealing with the current cache, before fetching
a remote resources.

In GQty the cache lives in JavaScript heaps and servers usually do not hint about
the cache lifetime, so it is up to developers who make assumptions on each and
every one of their own projects.

| Cache Policy                  | Description                                                                                                                                                                                                                                                                                                                        |
| :---------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `default`                     | Serves the cached contents when it is fresh, and if they are stale within the stale-while-revalidate (SWR) window, fetches in the background and updates the cache. Always fetches on stale cache or cache miss. <br /><br /> During SWR, a successful fetch will not notify cache updates. New contents are served on next query. |
| `no-cache`                    | Always fetch, updates client cache on response.                                                                                                                                                                                                                                                                                    |
| `no-store`                    | Always fetch and does not update on response. <br /><br /> GQty creates a temporary cache at query-level which immediately expires.                                                                                                                                                                                                |
| <nobr>`force-cache`</nobr>    | Serves the cached contents regardless of staleness. It fetches on cache miss or a stale cache, updates the cache on response.                                                                                                                                                                                                      |
| <nobr>`only-if-cached`</nobr> | Serves the cached contents regardless of staleness, throws a network error on cache miss.                                                                                                                                                                                                                                          |

<Alert title="Cache Policy is not Fetch Policy">
  Our React package has the option `fetchPolicy` which is heavily inspired by
  the Apollo Client. But over time, we found the WHATWG version more concise and
  easier to understand across multiple APIs.
</Alert>

## Cache Normalization

## Cache Persistence
